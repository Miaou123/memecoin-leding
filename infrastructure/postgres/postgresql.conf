# PostgreSQL SSL Configuration
# This file enables SSL/TLS for PostgreSQL connections

# SSL Settings
ssl = on
ssl_cert_file = '/var/lib/postgresql/ssl/server.crt'
ssl_key_file = '/var/lib/postgresql/ssl/server.key'
ssl_ca_file = '/var/lib/postgresql/ssl/ca.crt'

# Optional: Enable client certificate authentication
# ssl_crl_file = '/var/lib/postgresql/ssl/root.crl'

# SSL Ciphers (secure configuration)
ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'
ssl_prefer_server_ciphers = on
ssl_min_protocol_version = 'TLSv1.2'

# Optional: DH parameters for extra security
# ssl_dh_params_file = '/var/lib/postgresql/ssl/dhparams.pem'

# Connection settings
listen_addresses = '*'
port = 5432

# Authentication timeout
authentication_timeout = 1min

# Logging (useful for debugging SSL issues)
log_connections = on
log_disconnections = on
log_hostname = off

# Performance settings (adjust based on your needs)
shared_buffers = 256MB
effective_cache_size = 1GB
maintenance_work_mem = 64MB
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100
random_page_cost = 1.1
effective_io_concurrency = 200
work_mem = 4MB
min_wal_size = 1GB
max_wal_size = 4GB

# ========================================
# WAL Archiving Configuration for PITR
# ========================================

# Enable WAL archiving
wal_level = replica                    # Required for WAL archiving
archive_mode = on                      # Enable archiving
archive_timeout = 300                  # Force WAL switch every 5 minutes (max data loss)

# Archive command - calls our script that uploads to S3
# The %p is replaced by the path of the file to archive
# The %f is replaced by the file name only
archive_command = '/usr/local/bin/wal-scripts/wal-archive.sh %p %f'

# WAL sender settings (for future replication)
max_wal_senders = 3                    # Max concurrent WAL streaming connections
wal_keep_size = 1GB                    # Keep WAL files for streaming replication

# Checkpoint settings for consistent backups
checkpoint_timeout = 15min             # Maximum time between checkpoints
checkpoint_warning = 30s               # Warn if checkpoints take too long

# WAL writer settings
wal_writer_delay = 200ms               # WAL writer sleep time between flushes
wal_writer_flush_after = 1MB           # WAL writer flush size
commit_delay = 0                       # No delay for commits
wal_compression = on                   # Compress full-page writes in WAL

# Recovery settings (used when restoring from backup)
restore_command = 'aws s3 cp s3://${BACKUP_S3_BUCKET}/wal-archive/%f %p'
recovery_target_timeline = 'latest'    # Recover to the latest timeline

# Logging for WAL archiving
log_min_messages = warning
log_checkpoints = on
log_line_prefix = '%m [%p] %q%u@%d '
logging_collector = on
log_directory = 'pg_log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB