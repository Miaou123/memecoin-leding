;; PgBouncer configuration file for Memecoin Lending Protocol
;; Optimized for high-throughput transaction pooling

[databases]
;; Main database connection
;; host=postgres points to the PostgreSQL container
memecoin_lending = host=postgres port=5432 dbname=memecoin_lending

;; Admin database for monitoring (optional)
;; pgbouncer = host=postgres port=5432 dbname=pgbouncer auth_user=postgres

;; Template for adding more databases
;; dbname = host=postgres port=5432 dbname=actualdbname

[pgbouncer]
;; Connection settings
listen_addr = *
listen_port = 6432
unix_socket_dir = /tmp

;; Authentication
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

;; Admin users (for SHOW commands)
admin_users = postgres, admin
stats_users = stats, monitoring, admin

;; Pool configuration
;; Transaction pooling is best for web applications with short queries
pool_mode = transaction

;; Connection limits
max_client_conn = 1000          ; Maximum client connections to PgBouncer
default_pool_size = 25          ; Connections per user/database pair
min_pool_size = 5               ; Minimum connections to maintain
reserve_pool_size = 10          ; Reserve connections for burst traffic
reserve_pool_timeout = 5        ; Timeout for reserve pool

;; Maximum connections per database (overrides default_pool_size if needed)
max_db_connections = 100        ; Total connections per database
max_user_connections = 100      ; Total connections per user

;; Query handling
query_timeout = 0               ; 0 = disabled, otherwise in seconds
query_wait_timeout = 120        ; Maximum time to wait for a connection
idle_transaction_timeout = 0    ; Disconnect idle transactions (0 = disabled)
client_idle_timeout = 0         ; Disconnect idle clients (0 = disabled)

;; Connection lifecycle
server_lifetime = 3600          ; Maximum server connection age (1 hour)
server_idle_timeout = 600       ; Disconnect idle server connections (10 min)
server_connect_timeout = 15     ; Timeout for connecting to backend
server_login_retry = 15         ; Time to wait before retrying failed connection

;; TLS/SSL settings (for secure connections)
;; Uncomment and configure for production
; server_tls_sslmode = require
; server_tls_ca_file = /etc/pgbouncer/ca.crt
; server_tls_key_file = /etc/pgbouncer/server.key
; server_tls_cert_file = /etc/pgbouncer/server.crt
; client_tls_sslmode = allow
; client_tls_ca_file = /etc/pgbouncer/ca.crt
; client_tls_key_file = /etc/pgbouncer/client.key
; client_tls_cert_file = /etc/pgbouncer/client.crt

;; Logging
logfile = /var/log/pgbouncer/pgbouncer.log
pidfile = /var/run/pgbouncer/pgbouncer.pid

;; Log settings
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
log_stats = 1
stats_period = 60               ; Log stats every minute

;; Console access via TCP/IP
;; Connect with: psql -h localhost -p 6432 -U admin pgbouncer
admin_users = postgres, admin
stats_users = stats, monitoring

;; Other settings
tcp_keepalive = 1
tcp_keepcnt = 3
tcp_keepidle = 30
tcp_keepintvl = 10

;; Dangerous settings (use with caution)
ignore_startup_parameters = extra_float_digits, options

;; Performance optimization for production
;; Uncomment for production use
; so_reuseport = 1              ; Allow multiple processes to bind to same port
; pkt_buf = 4096                ; Larger packet buffer
; sbuf_loopcnt = 5              ; Increase for better throughput